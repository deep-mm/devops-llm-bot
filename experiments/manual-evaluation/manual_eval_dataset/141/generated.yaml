name: Build and Test

on: [push, pull_request]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
    - uses: actions/checkout@v3
      with:
        ref: ${{ github.ref }}
    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'
    - name: Grant execute permission for gradlew
      run: chmod +x ./android/gradlew
    - name: Build with Gradle
      run: ./android/gradlew build
    - name: Set up CMake
      uses: lukka/get-cmake@v3.21.3
    - name: Create build directory
      run: mkdir build
    - name: Configure CMake
      run: cmake -S . -B build
    - name: Build with CMake
      run: cmake --build build

  test:
    name: Test
    needs: build
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
    - uses: actions/checkout@v3
      with:
        ref: ${{ github.ref }}
    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'
    - name: Grant execute permission for gradlew
      run: chmod +x ./android/gradlew
    - name: Run Gradle test
      run: ./android/gradlew test
    - name: Set up CMake
      uses: lukka/get-cmake@v3.21.3
    - name: Change to build directory
      run: cd build
    - name: Run CMake test
      run: cmake --build build --target test
